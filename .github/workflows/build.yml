name: "æ„å»ºå®‰å“å†…æ ¸"

env:
  CONFIGURATION: "repos.json"
  OUT_DIR: "out"

on:
  workflow_dispatch:

jobs:
  Set-repos:
    name: "ğŸ‚ è§£æé…ç½®æ–‡ä»¶"
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.generate-matrix.outputs.repos }}
    steps:
      - name: "ğŸ˜„ æ‹‰å–æœ¬ä»“åº“ä»£ç "
        uses: actions/checkout@v4

      - name: "ğŸ˜† ç”Ÿæˆæ„å»ºçŸ©é˜µ"
        id: generate-matrix
        run: |
          echo "repos<<EOF" >> $GITHUB_OUTPUT
          cat  ${{ env.CONFIGURATION }} >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  Build-Kernel:
    name: "ğŸ æ­£åœ¨æ„å»ºå†…æ ¸"
    runs-on: ubuntu-latest
    needs:
      - Set-repos
    strategy:
      max-parallel: 2
      fail-fast: false
      matrix:
        repos: ${{ fromJSON(needs.Set-repos.outputs.repos) }}
    env:
      kernelDir: ${{ matrix.repos.kernelSource.name }}_${{ matrix.repos.kernelSource.device }}
      kernelName: ${{ matrix.repos.kernelSource.name }}
      kernelRepo: ${{ matrix.repos.kernelSource.repo }}
      kernelBranch: ${{ matrix.repos.kernelSource.branch }}
      kernelDevice: ${{ matrix.repos.kernelSource.device }}
      DEFCONFIG_NAME: ${{ matrix.repos.kernelSource.defconfig || format('{0}_defconfig', matrix.repos.kernelSource.device) }}
      withKernelSU: ${{ matrix.repos.withKernelSU }}
      
    steps:
      - name: "âœ¨ åˆ›å»ºå·¥ä½œç›®å½•"
        run: mkdir -p $kernelDir

      - name: "â­ å®‰è£…ç¯å¢ƒä¾èµ–"
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc curl git zip ftp gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi libssl-dev lftp zstd wget libfl-dev python3 libarchive-tools jq

      - name: "ğŸŒŸ æ‹‰å–å†…æ ¸æºç "
        working-directory: ./${{ env.kernelDir }}
        run: |
          git clone --recursive --branch $kernelBranch $kernelRepo $kernelName --depth=1

      - name: "ğŸ’« é…ç½®ç¼–è¯‘å·¥å…·é“¾"
        working-directory: ./${{ env.kernelDir }}
        env:
          toolchains: "${{ toJSON(matrix.repos.toolchains) }}"
        run: |
          toolchains_num="$(echo $toolchains | jq 'length')"
          for ((i=0;i<toolchains_num;i++)); do
            name=$(echo $toolchains | jq -r ".[$i].name")
            repo=$(echo $toolchains | jq -r ".[$i].repo")
            branch=$(echo $toolchains | jq -r ".[$i].branch")
            url=$(echo $toolchains | jq -r ".[$i].url // empty")
            
            if [ -n "$url" ]; then
              echo "æ­£åœ¨ä» URL ä¸‹è½½å·¥å…·é“¾: $name"
              mkdir -p $name
              curl -L "$url" | tar -xz -C $name
            else
              echo "æ­£åœ¨å…‹éš†ä»“åº“å·¥å…·é“¾: $name"
              git clone --recursive --branch $branch $repo $name --depth=1
            fi

            # --- æ ¸å¿ƒä¿®å¤é€»è¾‘ ---
            if [ -d "$(pwd)/$name/bin" ]; then
               echo "æ­£åœ¨ä¿®å¤å·¥å…·é“¾é“¾æ¥å™¨å…¼å®¹æ€§..."
               # åˆ é™¤å·¥å…·é“¾è‡ªå¸¦çš„æ—§ç‰ˆé“¾æ¥å™¨
               rm -rf $(pwd)/$name/bin/ld $(pwd)/$name/bin/ld.lld $(pwd)/$name/bin/ld64.lld
               # åˆ›å»ºè½¯é“¾æ¥æŒ‡å‘ç³»ç»Ÿçš„ lld (Ubuntu 24.04 çš„ç³»ç»Ÿ lld æ”¯æŒ .relr.dyn)
               ln -sf /usr/bin/lld $(pwd)/$name/bin/ld.lld
               ln -sf /usr/bin/lld $(pwd)/$name/bin/ld
            fi
            # ------------------

            
            echo "$(pwd)/$name/bin" >> $GITHUB_PATH
            # å…¼å®¹æŸäº›æ²¡æœ‰ bin ç›®å½•çš„å·¥å…·é“¾
            echo "$(pwd)/$name" >> $GITHUB_PATH
          done

      - name: "ğŸ˜ é…ç½®ç¼–è¯‘å‚æ•°"
        id: generate-args
        working-directory: ./${{ env.kernelDir }}
        env:
          params: "${{ toJSON(matrix.repos.params) }}"
        run: |
          ARCH=$(echo $params | jq -r ".ARCH // \"arm64\"")
          echo "ARCH=$ARCH" >> $GITHUB_ENV
          
          args="-j$(nproc --all)"
          if [ -n "${{ env.OUT_DIR }}" ]; then
            mkdir -p $(pwd)/${{ env.OUT_DIR }}
            args="$args O=$(pwd)/${{ env.OUT_DIR }}"
          fi
          
          # éå†è§£æ externalCommand ä¸­çš„æ‰€æœ‰å‚æ•° (å¦‚ LLVM=1)
          ext_commands=$(echo $params | jq -r ".externalCommand // {} | to_entries | .[] | \"\(.key)=\(.value)\"")
          for cmd in $ext_commands; do
            args="$args $cmd"
          done

          # åŸºç¡€ç¼–è¯‘å™¨å‚æ•°
          CC=$(echo $params | jq -r ".CC // empty")
          [ -n "$CC" ] && args="$args CC=$CC"
          
          echo "æœ€ç»ˆç¼–è¯‘å‚æ•°: $args"
          echo "args=$args" >> $GITHUB_OUTPUT

      - name: "ğŸ˜‹ æ³¨å…¥ KernelSU"
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        if: ${{ env.withKernelSU == 'true' }}
        run: |
          [ -d "./KernelSU" ] && rm -rf "./KernelSU"
          [ -d "./drivers/kernelsu" ] && rm -rf "./drivers/kernelsu"
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          
          # ç¡®ä¿å¼€å¯ KPROBES ä¾èµ–
          CONFIG_PATH="./arch/${{ env.ARCH }}/configs/${{ env.DEFCONFIG_NAME }}"
          sed -i '/CONFIG_KPROBES/d' $CONFIG_PATH
          sed -i '/CONFIG_HAVE_KPROBES/d' $CONFIG_PATH
          sed -i '/CONFIG_KPROBE_EVENTS/d' $CONFIG_PATH
          echo -e "\nCONFIG_KPROBES=y\nCONFIG_HAVE_KPROBES=y\nCONFIG_KPROBE_EVENTS=y" >> $CONFIG_PATH

      - name: "ğŸ‘ æ‰§è¡Œå‰ç½®å‘½ä»¤å¹¶ç”Ÿæˆé…ç½®"
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        env:
          args: ${{ steps.generate-args.outputs.args }}
          params: "${{ toJSON(matrix.repos.params) }}"
        run: |
          PRE_CMD=$(echo $params | jq -r ".externalCommand.pre_build_command // empty")
          if [ -n "$PRE_CMD" ]; then
            echo "æ­£åœ¨æ‰§è¡Œåˆå¹¶é…ç½®å‘½ä»¤..."
            eval "$PRE_CMD"
          fi
          make ${{ env.args }} ${{ env.DEFCONFIG_NAME }}

      - name: "ğŸ¶ å¼€å§‹ç¼–è¯‘å†…æ ¸"
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        env:
          args: ${{ steps.generate-args.outputs.args }}
        run: |
          make ${{ env.args }}

      - name: "ğŸ’› ä¸Šä¼  Image äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: Image-${{ env.kernelDevice }}
          path: ./${{ env.kernelDir }}/${{ env.OUT_DIR }}/arch/${{ env.ARCH }}/boot/Image
          if-no-files-found: ignore

      - name: "ğŸ’™ ä¸Šä¼  Image.gz äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: Image-GZ-${{ env.kernelDevice }}
          path: ./${{ env.kernelDir }}/${{ env.OUT_DIR }}/arch/${{ env.ARCH }}/boot/Image.gz
          if-no-files-found: ignore

      - name: "ğŸ’œ ä¸Šä¼  dtb äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: DTB-${{ env.kernelDevice }}
          path: ./${{ env.kernelDir }}/${{ env.OUT_DIR }}/arch/${{ env.ARCH }}/boot/dtb
          if-no-files-found: ignore

      - name: "â¤ï¸ ä¸Šä¼  dtbo.img äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: DTBO-${{ env.kernelDevice }}
          path: ./${{ env.kernelDir }}/${{ env.OUT_DIR }}/arch/${{ env.ARCH }}/boot/dtbo.img
          if-no-files-found: ignore
