name: "æ„å»ºå®‰å“å†…æ ¸ (çº¯å‡€ç‰ˆ)"

env:
  CONFIGURATION: "repos.json"
  OUT_DIR: "out"

on:
  workflow_dispatch:

jobs:
  Set-repos:
    name: "ğŸ” è§£æé…ç½®æ–‡ä»¶"
    runs-on: ubuntu-22.04
    outputs:
      repos: ${{ steps.generate-matrix.outputs.repos }}
    steps:
      - name: "æ‹‰å–æœ¬ä»“åº“ä»£ç "
        uses: actions/checkout@v4

      - name: "ç”Ÿæˆæ„å»ºçŸ©é˜µ"
        id: generate-matrix
        run: |
          echo "repos<<EOF" >> $GITHUB_OUTPUT
          cat ${{ env.CONFIGURATION }} >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  Build-Kernel:
    name: "ğŸ”¨ æ­£åœ¨æ„å»º"
    runs-on: ubuntu-22.04
    needs:
      - Set-repos
    strategy:
      max-parallel: 2
      fail-fast: false
      matrix:
        repos: ${{ fromJSON(needs.Set-repos.outputs.repos) }}
    env:
      kernelDir: ${{ matrix.repos.kernelSource.name }}_${{ matrix.repos.kernelSource.device }}
      kernelName: ${{ matrix.repos.kernelSource.name }}
      kernelRepo: ${{ matrix.repos.kernelSource.repo }}
      kernelBranch: ${{ matrix.repos.kernelSource.branch }}
      kernelDevice: ${{ matrix.repos.kernelSource.device }}
      DEFCONFIG_NAME: ${{ matrix.repos.kernelSource.defconfig }}
      withKernelSU: ${{ matrix.repos.withKernelSU }}

    steps:
      - name: "ğŸ“ åˆ›å»ºå·¥ä½œç›®å½•"
        run: mkdir -p $kernelDir

      - name: "ğŸ› ï¸ å®‰è£…ç¯å¢ƒä¾èµ–"
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc curl git zip gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi libssl-dev lftp zstd wget libfl-dev python2 python3 jq libarchive-tools

      - name: "ğŸ“¥ æ‹‰å–å†…æ ¸æºç "
        working-directory: ./${{ env.kernelDir }}
        run: |
          git clone --recursive --branch $kernelBranch $kernelRepo $kernelName --depth=1

      - name: "ğŸ”§ é…ç½®ç¼–è¯‘å·¥å…·é“¾"
        working-directory: ./${{ env.kernelDir }}
        env:
          toolchains: "${{ toJSON(matrix.repos.toolchains) }}"
        run: |
          toolchains_num=$(echo $toolchains | jq 'length')
          for ((i=0;i<toolchains_num;i++)); do
            name=$(echo $toolchains | jq -r ".[$i].name")
            repo=$(echo $toolchains | jq -r ".[$i].repo")
            branch=$(echo $toolchains | jq -r ".[$i].branch")
            git clone --recursive --branch $branch $repo $name --depth=1
            echo "$(pwd)/$name/bin" >> $GITHUB_PATH
          done

      - name: "ğŸ“ é…ç½®ç¼–è¯‘å‚æ•°"
        id: generate-args
        working-directory: ./${{ env.kernelDir }}
        env:
          params: "${{ toJSON(matrix.repos.params) }}"
        run: |
          # è®¾ç½®æ¶æ„
          ARCH=$(echo $params | jq -r ".ARCH // \"arm64\"")
          echo "ARCH=$ARCH" >> $GITHUB_ENV
          
          # ç»„è£…åŸºç¡€å‚æ•°
          args="-j$(nproc --all) O=$(pwd)/${{ env.OUT_DIR }} ARCH=$ARCH"
          
          # è§£æå¤–éƒ¨å‚æ•° (LLVM=1, CC=clang ç­‰)
          ext_commands=$(echo $params | jq -r ".externalCommand // {} | to_entries | .[] | \"\(.key)=\(.value)\"")
          for cmd in $ext_commands; do
            args="$args $cmd"
          done

          CC=$(echo $params | jq -r ".CC // empty")
          [ -n "$CC" ] && args="$args CC=$CC"
          
          echo "args=$args" >> $GITHUB_OUTPUT

      - name: "ğŸ’‰ æ³¨å…¥ KernelSU (ä»…å½“å¼€å¯æ—¶)"
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        if: ${{ env.withKernelSU == 'true' }}
        run: |
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          CONFIG_PATH="./arch/${{ env.ARCH }}/configs/${{ env.DEFCONFIG_NAME }}"
          echo -e "\nCONFIG_KPROBES=y\nCONFIG_HAVE_KPROBES=y\nCONFIG_KPROBE_EVENTS=y" >> $CONFIG_PATH

      - name: "âš™ï¸ ç”Ÿæˆ .config"
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        env:
          args: ${{ steps.generate-args.outputs.args }}
          params: "${{ toJSON(matrix.repos.params) }}"
        run: |
          # æ‰§è¡Œ pre_build_command (å¦‚ä½ ä¹‹å‰çš„ CONFIG_USB_RTL8152 æ³¨å…¥)
          PRE_CMD=$(echo $params | jq -r ".externalCommand.pre_build_command // empty")
          [ -n "$PRE_CMD" ] && eval "$PRE_CMD"
          make ${{ env.args }} ${{ env.DEFCONFIG_NAME }}

      - name: "ğŸš€ å¼€å§‹å…¨é‡ç¼–è¯‘"
        working-directory: ./${{ env.kernelDir }}/${{ env.kernelName }}
        env:
          args: ${{ steps.generate-args.outputs.args }}
        run: |
          # 1. é¦–å…ˆç¼–è¯‘å†…æ ¸é•œåƒ
          make ${{ env.args }} Image.gz
          
          # 2. ç¼–è¯‘è®¾å¤‡æ ‘ (è¿™é€šå¸¸ä¼šåŒæ—¶ç”Ÿæˆ .dtb å’Œ .dtbo)
          # å¦‚æœä½ çš„æºç æ”¯æŒï¼Œå®ƒä¼šç”Ÿæˆåœ¨ out/arch/arm64/boot/dts/vendor/
          make ${{ env.args }} dtbs

      - name: "ğŸ‘Œ å°è¯•æå–å¹¶åˆæˆ DTBO"
        working-directory: ./${{ env.kernelDir }}
        run: |
          # å¯»æ‰¾ mkdtimg å·¥å…·ï¼ˆå†…æ ¸è‡ªå¸¦ï¼‰
          MKDTIMG=$(find ${{ env.OUT_DIR }} -name mkdtimg | head -n 1)
          if [ -n "$MKDTIMG" ]; then
            # å¯»æ‰¾æ‰€æœ‰çš„ dtbo æ–‡ä»¶å¹¶åˆæˆ dtbo.img
            DTBO_FILES=$(find ${{ env.OUT_DIR }} -name "*.dtbo")
            if [ -n "$DTBO_FILES" ]; then
              $MKDTIMG create ${{ env.OUT_DIR }}/arch/arm64/boot/dtbo.img $DTBO_FILES
              echo "âœ… å·²æˆåŠŸæ‰‹åŠ¨åˆæˆ dtbo.img"
            fi
          fi

      - name: "ğŸ“¦ åˆ¶ä½œ AnyKernel3 åˆ·æœºåŒ…"
        working-directory: ./${{ env.kernelDir }}
        run: |
          git clone --depth=1 ${{ matrix.repos.AnyKernel3.repo }} -b ${{ matrix.repos.AnyKernel3.branch }} AnyKernel3
          
          # æ‹·è´å†…æ ¸é•œåƒ
          cp ${{ env.OUT_DIR }}/arch/${{ env.ARCH }}/boot/Image.gz AnyKernel3/ 2>/dev/null || cp ${{ env.OUT_DIR }}/arch/${{ env.ARCH }}/boot/Image AnyKernel3/
          
          # è‡ªåŠ¨å¯»æ‰¾å¹¶æ‹·è´ dtb å’Œ dtbo.img (é€’å½’æŸ¥æ‰¾é˜²æ­¢è·¯å¾„å˜åŠ¨)
          find ${{ env.OUT_DIR }}/arch/${{ env.ARCH }}/boot/dts/ -name "*.dtb" -exec cp {} AnyKernel3/dtb \; 2>/dev/null || true
          find ${{ env.OUT_DIR }}/ -name "dtbo.img" -exec cp {} AnyKernel3/dtbo.img \; 2>/dev/null || true
          
          cd AnyKernel3
          rm -rf .git README.md
          zip -r9 ../${{ env.kernelDevice }}-kernel.zip *

      - name: "ğŸ“¤ ä¸Šä¼ æ‰€æœ‰äº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-Result-${{ env.kernelDevice }}
          path: |
            ./${{ env.kernelDir }}/${{ env.OUT_DIR }}/arch/arm64/boot/Image
            ./${{ env.kernelDir }}/${{ env.OUT_DIR }}/arch/arm64/boot/Image.gz
            ./${{ env.kernelDir }}/${{ env.OUT_DIR }}/arch/arm64/boot/dtbo.img
            ./${{ env.kernelDir }}/${{ env.OUT_DIR }}/arch/arm64/boot/dtb
            ./${{ env.kernelDir }}/*.zip
          if-no-files-found: warn
